# Graphqlå®è·µâ€”â€”åˆ†é¡µä¸ç¼“å­˜
----
## Graphqlåˆ†é¡µ
graphqlå®ç°åˆ†é¡µæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š
1. åŸºäºåç§»é‡,éœ€è¦æä¾›ç¬¬å‡ é¡µï¼Œ æ¯é¡µçš„æ•°é‡
2. åŸºäºæ¸¸æ ‡æˆ–è€…idï¼Œæä¾›æ¯é¡µæ•°é‡ï¼Œä¸ æ¸¸æ ‡/idã€‚  
å¯¹äºæ¸¸æ ‡åˆ†é¡µ[Relay](https://github.com/facebook/relay)(Facebookå®¶çš„Graphqlåº“) å®šäº†ä¸€å¥—è§„èŒƒ [Relay-style cursor pagination](https://facebook.github.io/relay/graphql/connections.htm)  

**åŸºäºåç§»é‡çš„åˆ†é¡µå®ç°ç®€å•ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š**
 - æ€§èƒ½é—®é¢˜ï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨ â€œå»¶è¿Ÿå…³è”â€ è§£å†³ï¼Œä½†ä¼šä½¿sqlè¯­å¥å˜å¾—å¤æ‚
    ```sql
    # å‡è®¾ æœ‰ä¸€ä¸ª productå•†å“è¡¨ï¼Œå½“å•†å“è¡¨æ•°é‡è¶³å¤Ÿå¤šæ—¶ï¼Œè¿™ä¸ªæŸ¥è¯¢ä¼šå˜å¾—éå¸¸ç¼“æ…¢ï¼Œ
    SELECT id, name FROM product LIMIT 1000, 20;
    # å¦‚æœæˆ‘ä»¬æä¾›ä¸€ä¸ªè¾¹ç•Œå€¼ï¼Œæ¯”å¦‚idï¼Œæ— è®ºç¿»é¡µåˆ°å¤šä¹ˆåé¢ï¼Œå…¶æ€§èƒ½éƒ½ä¼šå¾ˆå¥½
    SELECT id, name FROM product WHERE id > 1000 LIMIT 20;
    ```

- åˆ é™¤åˆ—è¡¨æ•°æ®æ—¶ï¼Œå¯¼è‡´è·å–ä¸‹ä¸€é¡µçš„æ•°æ®ç¼ºå¤±
    ```sql
    # å‡è®¾ æ€»å…±æœ‰11æ¡æ•°æ®ï¼Œä¸€é¡µæ˜¾ç¤º10æ¡ï¼Œæ€»é¡µæ•°ä¸º 2 é¡µã€‚
    # å½“è°ƒç”¨æ¥å£åˆ é™¤ ç¬¬ 1 é¡µçš„ 1 æ¡æ•°æ®ï¼Œç„¶åè¿›è¡Œç¿»é¡µæ—¶ï¼Œå› ä¸ºåªå‰©ä¸‹10æ¡æ•°æ®ï¼Œæ‰€ä»¥ä¸‹é¢çš„sqlä¼šæŸ¥ä¸åˆ°æ•°æ®ã€‚
    SELECT id, name FROM product LIMIT 10, 10;
    ```
 
**åŸºäºæ¸¸æ ‡/ID çš„åˆ†é¡µï¼Œä¹Ÿå­˜åœ¨ç¡¬ä¼¤ï¼š**  
- å¦‚ä½•å®ç°è·³å¾€ç¬¬ n é¡µçš„åŠŸèƒ½  
    éš¾é“è¦è·å– ç›¸åº”çš„æ¸¸æ ‡å†è¿›è¡Œç¿»é¡µï¼Ÿ:joy: æ‰€ä»¥å®ƒæ›´é€‚ç”¨äºæ— é™åŠ è½½ï¼Œæˆ–è€…åªæœ‰ ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ çš„æƒ…æ™¯ä¸Š,å¯¹äºè·³å¾€ç¬¬né¡µè¿˜æ˜¯éœ€è¦ç”¨åˆ°åŸºäºåç§»é‡çš„åˆ†é¡µã€‚  

**æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŒæ—¶æ”¯æŒè¿™ä¸¤ç§åˆ†é¡µã€‚**  
![](../.gitbook/assets/graphql/æˆ‘å…¨éƒ½è¦.jpeg)
### Relay å¼çš„æ¸¸æ ‡åˆ†é¡µ ###
Relay å®šä¹‰äº† PageInfoï¼ŒEdgesï¼ŒEdge Typesï¼ŒNodeï¼ŒCursorç­‰å¯¹è±¡ ç”¨äºå®ç°çµæ´»çš„åˆ†é¡µã€‚ğŸ‘‡æ˜¯Relayç»™å‡ºçš„ä¸€ä¸ªqueryä¾‹å­ã€‚
```
{
  user {
    id
    name
    friends(first: 10, after: "opaqueCursor") {
      edges {
        cursor
        node {
          id
          name
        }
      }
      pageInfo {
        hasNextPage
      }
    }
  }
}
```
friends è¿æ¥ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡çš„åç§°ä¼šä»¥ `Connection`ç»“å°¾ï¼Œå¦‚`friendConnection`, `Connection`ä¸­å¿…éœ€åŒ…å«`PageInfo`ï¼Œ`Edges`ã€‚
#### PageInfo ####
Relay åœ¨è¿”å›çš„æ¸¸æ ‡è¿æ¥ä¸Šæä¾›äº†ä¸€ä¸ª **PageInfo** å¯¹è±¡ï¼Œå…¶å¿…éœ€åŒ…å« hasPreviousPageï¼Œ hasNextPageã€‚
- startCursor : åˆ—è¡¨ä¸­ ç¬¬ä¸€ä¸ªé¡¹çš„æ¸¸æ ‡idï¼Œå­—ç¬¦ä¸²
- endCursor : æœ€åä¸€ä¸ªé¡¹çš„æ¸¸æ ‡id
- hasPreviousPage : æ˜¯å¦æœ‰ä¸Šä¸€é¡µï¼Œå¸ƒå°”å€¼
- hasNextPage :æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ

> æ¸¸æ ‡æ˜¯ä¸é€æ˜çš„ï¼Œå¹¶ä¸”å®ƒä»¬çš„æ ¼å¼ä¸åº”è¯¥è¢«ä¾èµ–ï¼Œå»ºè®®ç”¨ base64 ç¼–ç å®ƒä»¬ã€‚

#### Edges ####
`Edges`ï¼šç±»å‹ä¸º `LIST` ,å¿…éœ€åŒ…å«`Edge Types`  
`Edge Types`ï¼šç±»å‹ä¸º `Object`,å¿…éœ€åŒ…å« `Node`ï¼Œ`Cursor`  
`Node`: ç±»å‹å¯ä»¥ä¸º æ ‡é‡ï¼Œæšä¸¾ï¼Œå¯¹è±¡ï¼Œæ¥å£ï¼Œè”åˆç±»å‹,æ­¤å­—æ®µæ— æ³•è¿”å›åˆ—è¡¨ã€‚
`Cursor`: ç±»å‹ä¸º`String`  

é€šè¿‡Edgesï¼Œåˆ—è¡¨æ•°æ®ä¸­æ¯ä¸€é¡¹éƒ½åŒ…å«ä¸€ä¸ªCursorã€Node,ä½†æˆ‘ä»¬åŸºæœ¬å¾ˆå°‘éœ€è¦Cursorã€‚

#### ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ ####
ä¸‹ä¸€é¡µåˆ†é¡µï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•°ã€‚
- first é¡µæ•°å¤§å°ï¼Œå¿…éœ€ä¸ºä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚
- after æ¸¸æ ‡idã€‚
æœåŠ¡å™¨æœ€å¤šè¿”å› first æ¡ æ¸¸æ ‡idä¹‹åï¼ˆä¸åŒ…æ‹¬æ¸¸æ ‡idï¼‰ çš„æ•°æ®ã€‚

ä¸Šä¸€é¡µåˆ†é¡µï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•°ã€‚
- last é¡µæ•°å¤§å°ï¼Œå¿…éœ€ä¸ºä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚
- before æ¸¸æ ‡idã€‚
æœåŠ¡å™¨æœ€å¤šè¿”å› last æ¡ æ¸¸æ ‡idä¹‹å‰ï¼ˆä¸åŒ…æ‹¬æ¸¸æ ‡idï¼‰ çš„æ•°æ®ã€‚

> firstè·Ÿlastä¸åº”è¯¥åŒæ—¶ä½¿ç”¨ï¼Œè¿™ä¼šä½¿åˆ¤æ–­ ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ å˜å¾—éº»çƒ¦ã€‚

### æ”¯æŒåŸºäºåç§»é‡çš„åˆ†é¡µ ###
æˆ‘ä»¬éœ€è¦åœ¨queryæ—¶ï¼ŒæŠŠç¬¬ n é¡µè¿™ä¸ªå‚æ•°ç»™åˆ° service ç«¯ï¼Œåç«¯æ ¹æ®è¿™ä¸ªå€¼ æ˜¯å¦ `null`å»ä½¿ç”¨ä¸åŒåˆ†é¡µæ–¹å¼ã€‚[Prisma](https://github.com/prisma/prisma)æŠŠè¿™ä¸ªå‚æ•°å‘½åä¸º `skip`ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸å…¶ä¿æŒä¸€è‡´ã€‚
```
{
  user {
    id
    name
    friends(first: 10, after: "opaqueCursor", skip: 2) {
      edges {
        node {
          id
          name
        }
      }
      pageInfo {
        hasNextPage
      }
    }
  }
}
```

### ä½¿ç”¨ apollo-client åˆ†é¡µ
1. ä½¿ç”¨ fetchMoreï¼šé€‚ç”¨äºæ— é™æ»šåŠ¨
2. ä½¿ç”¨ query
## apollo-client ç¼“å­˜
